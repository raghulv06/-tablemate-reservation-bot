<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TableMate ‚Äî AI Restaurant Concierge</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0a; --surface: #141414; --surface2: #1e1e1e;
    --border: #2a2a2a; --gold: #c9a84c; --gold-light: #e8c97a;
    --text: #f0ece4; --text-muted: #7a7570; --text-dim: #4a4540;
    --accent: #e05c3a; --green: #4caf7d;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }

  header { background: rgba(10,10,10,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); padding: 0 2rem; height: 64px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
  .logo { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--gold); }
  .logo span { color: var(--text); }
  .status-bar { display: flex; align-items: center; gap: 1.5rem; font-size: 0.8rem; color: var(--text-muted); }
  .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); display: inline-block; margin-right: 6px; animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  .app { display: grid; grid-template-columns: 300px 1fr 280px; height: calc(100vh - 64px); overflow: hidden; }

  /* SIDEBAR */
  .sidebar { background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; }
  .sidebar-section { padding: 1.25rem; border-bottom: 1px solid var(--border); }
  .sidebar-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--text-muted); margin-bottom: 1rem; }

  .rest-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 0.9rem; margin-bottom: 0.6rem; cursor: pointer; transition: all 0.2s; }
  .rest-card:hover, .rest-card.active { border-color: var(--gold); background: rgba(201,168,76,0.06); }
  .rest-name { font-family: 'Playfair Display', serif; font-size: 0.95rem; margin-bottom: 4px; }
  .rest-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 0.8rem; align-items: center; }
  .avail-badge { margin-left: auto; font-size: 0.7rem; color: var(--green); background: rgba(76,175,125,0.1); padding: 2px 8px; border-radius: 20px; }
  .avail-badge.few { color: var(--accent); background: rgba(224,92,58,0.1); }

  .table-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
  .tbl { aspect-ratio: 1; border-radius: 6px; border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.58rem; color: var(--text-muted); transition: all 0.2s; }
  .tbl.available { border-color: var(--green); color: var(--green); background: rgba(76,175,125,0.05); }
  .tbl.reserved { border-color: var(--accent); color: var(--accent); background: rgba(224,92,58,0.05); }

  .wl-item { display: flex; align-items: center; gap: 0.7rem; padding: 0.6rem 0; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
  .wl-avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--surface2); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: var(--gold); flex-shrink: 0; }
  .wl-wait { color: var(--gold); font-size: 0.72rem; margin-left: auto; white-space: nowrap; }

  /* CHAT */
  .chat-area { display: flex; flex-direction: column; }
  .chat-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); background: var(--surface); display: flex; align-items: center; gap: 1rem; }
  .bot-av { width: 42px; height: 42px; border-radius: 12px; background: linear-gradient(135deg, var(--gold), var(--accent)); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
  .bot-name { font-weight: 600; }
  .bot-sub { font-size: 0.75rem; color: var(--text-muted); }
  .quick-btns { margin-left: auto; display: flex; gap: 0.5rem; }
  .qbtn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 5px 10px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
  .qbtn:hover { border-color: var(--gold); color: var(--gold); }

  .messages { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; scroll-behavior: smooth; }
  .messages::-webkit-scrollbar { width: 3px; } .messages::-webkit-scrollbar-thumb { background: var(--border); }

  .msg { display: flex; gap: 0.75rem; animation: msgIn 0.3s ease; }
  @keyframes msgIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  .msg.user { flex-direction: row-reverse; }
  .msg-av { width: 32px; height: 32px; border-radius: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
  .msg.bot .msg-av { background: linear-gradient(135deg, var(--gold), var(--accent)); }
  .msg.user .msg-av { background: var(--surface2); border: 1px solid var(--border); }
  .msg-bubble { max-width: 70%; padding: 0.8rem 1rem; border-radius: 12px; font-size: 0.875rem; line-height: 1.6; }
  .msg.bot .msg-bubble { background: #1c1a14; border: 1px solid var(--border); border-bottom-left-radius: 4px; }
  .msg.user .msg-bubble { background: #1a1a2e; border: 1px solid #2a2a4a; border-bottom-right-radius: 4px; color: #c0c8f0; }
  .msg-time { font-size: 0.65rem; color: var(--text-dim); margin-top: 4px; }
  .msg.user .msg-time { text-align: right; }
  .msg-bubble strong { color: var(--gold); }

  /* CHIPS */
  .chips { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.6rem; }
  .chip { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 5px 12px; border-radius: 20px; font-size: 0.78rem; cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
  .chip:hover { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.08); }

  /* BOOKING CARD */
  .bk-card { background: var(--surface2); border: 1px solid var(--gold); border-radius: 10px; padding: 1rem; margin-top: 0.5rem; }
  .bk-title { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--gold); margin-bottom: 0.5rem; }
  .bk-row { display: flex; justify-content: space-between; font-size: 0.8rem; padding: 4px 0; border-bottom: 1px solid var(--border); color: var(--text-muted); }
  .bk-row:last-of-type { border: none; }
  .bk-row strong { color: var(--text); }
  .bk-btns { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
  .bk-btn { flex: 1; padding: 8px; border-radius: 7px; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 500; transition: all 0.2s; }
  .bk-btn.primary { background: var(--gold); color: #0a0a0a; }
  .bk-btn.primary:hover { background: var(--gold-light); }
  .bk-btn.secondary { background: var(--surface); color: var(--text-muted); border: 1px solid var(--border); }
  .bk-btn.secondary:hover { border-color: var(--text-muted); color: var(--text); }

  /* MENU */
  .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem; }
  .mi { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 0.7rem; font-size: 0.78rem; }
  .mi-name { font-weight: 500; margin-bottom: 2px; }
  .mi-desc { color: var(--text-muted); font-size: 0.72rem; line-height: 1.4; }
  .mi-price { color: var(--gold); margin-top: 4px; }
  .di-tag { display: inline-block; font-size: 0.62rem; padding: 1px 6px; border-radius: 4px; background: rgba(76,175,125,0.15); color: var(--green); margin-top: 3px; margin-right: 3px; }

  /* SUCCESS */
  .success-box { background: rgba(76,175,125,0.1); border: 1px solid var(--green); border-radius: 10px; padding: 1rem; text-align: center; margin-top: 0.5rem; }
  .success-icon { font-size: 2rem; margin-bottom: 0.5rem; }
  .success-title { color: var(--green); font-weight: 600; margin-bottom: 6px; }
  .conf-num { color: var(--gold); font-family: monospace; font-size: 1rem; font-weight: 700; }
  .sms-note { color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem; padding: 6px 10px; background: var(--surface2); border-radius: 6px; }

  /* INPUT */
  .input-area { padding: 1rem 1.5rem; background: var(--surface); border-top: 1px solid var(--border); }
  .input-row { display: flex; gap: 0.7rem; align-items: flex-end; }
  .chat-input { flex: 1; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 0.75rem 1rem; border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 0.875rem; resize: none; outline: none; transition: border-color 0.2s; max-height: 120px; }
  .chat-input:focus { border-color: var(--gold); }
  .chat-input::placeholder { color: var(--text-dim); }
  .send-btn { width: 44px; height: 44px; border-radius: 10px; background: var(--gold); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
  .send-btn:hover { background: var(--gold-light); transform: scale(1.05); }
  .typing { display: none; gap: 4px; padding: 10px 1.5rem; }
  .tdot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted); animation: td 1.2s infinite; }
  .tdot:nth-child(2){animation-delay:.2s} .tdot:nth-child(3){animation-delay:.4s}
  @keyframes td { 0%,100%{transform:translateY(0);opacity:.4} 50%{transform:translateY(-4px);opacity:1} }

  /* RIGHT PANEL */
  .right-panel { background: var(--surface); border-left: 1px solid var(--border); overflow-y: auto; }
  .panel-section { padding: 1.25rem; border-bottom: 1px solid var(--border); }
  .panel-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--text-muted); margin-bottom: 1rem; }
  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; }
  .stat-box { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 0.8rem; text-align: center; }
  .stat-num { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--gold); display: block; }
  .stat-label { font-size: 0.68rem; color: var(--text-muted); }
  .upcoming-item { display: flex; gap: 0.7rem; padding: 0.7rem 0; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
  .utime { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; text-align: center; min-width: 52px; flex-shrink: 0; }
  .utime .hr { font-weight: 600; font-size: 0.85rem; color: var(--gold); }
  .utime .ap { font-size: 0.65rem; color: var(--text-muted); }

  /* TOAST */
  .toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--surface); border: 1px solid var(--gold); border-radius: 10px; padding: 1rem 1.25rem; display: none; gap: 0.75rem; align-items: center; box-shadow: 0 4px 24px rgba(0,0,0,0.5); animation: toastIn 0.3s ease; z-index: 999; }
  @keyframes toastIn { from{transform:translateX(110%)} to{transform:translateX(0)} }
  .toast-title { font-weight: 600; color: var(--gold); }
  .toast-sub { color: var(--text-muted); font-size: 0.78rem; }

  @media(max-width:1100px){.app{grid-template-columns:260px 1fr;} .right-panel{display:none}}
  @media(max-width:768px){.app{grid-template-columns:1fr;} .sidebar{display:none}}
</style>
</head>
<body>
<header>
  <div class="logo">Table<span>Mate</span></div>
  <div class="status-bar">
    <span><span class="live-dot"></span>Live</span>
    <span id="curDate"></span>
    <span>üçΩÔ∏è 3 restaurants</span>
  </div>
</header>

<div class="app">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">Restaurants</div>
      <div id="restList"></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Table Map</div>
      <div class="table-grid" id="tableGrid"></div>
    </div>
    <div class="sidebar-section" style="flex:1;overflow-y:auto">
      <div class="sidebar-title">Waitlist <span id="wlCount" style="background:var(--accent);color:white;border-radius:10px;padding:1px 6px;font-size:0.65rem;margin-left:4px">0</span></div>
      <div id="waitlistEl"></div>
    </div>
  </div>

  <!-- CHAT -->
  <div class="chat-area">
    <div class="chat-header">
      <div class="bot-av">ü§µ</div>
      <div><div class="bot-name">TableMate Assistant</div><div class="bot-sub">AI-powered dining concierge</div></div>
      <div class="quick-btns">
        <button class="qbtn" onclick="quickSend('Book a table')">+ Reserve</button>
        <button class="qbtn" onclick="quickSend('View my reservations')">My Bookings</button>
        <button class="qbtn" onclick="quickSend('Join waitlist')">Waitlist</button>
      </div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="typing" id="typing"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div>
    <div class="input-area">
      <div class="input-row">
        <textarea class="chat-input" id="chatInput" rows="1" placeholder="Type a message... e.g. 'Book a table for 4 on Friday at 7pm'" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" onclick="sendMessage()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0a0a0a" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">
    <div class="panel-section">
      <div class="panel-title">Today's Stats</div>
      <div class="stat-grid" id="statsGrid">
        <div class="stat-box"><span class="stat-num" id="sTotal">0</span><div class="stat-label">Reservations</div></div>
        <div class="stat-box"><span class="stat-num" id="sAvail">0</span><div class="stat-label">Available</div></div>
        <div class="stat-box"><span class="stat-num" id="sWait">0</span><div class="stat-label">Waitlisted</div></div>
        <div class="stat-box"><span class="stat-num" id="sOcc">0%</span><div class="stat-label">Occupancy</div></div>
      </div>
    </div>
    <div class="panel-section">
      <div class="panel-title">Your Reservations</div>
      <div id="myReservations" style="font-size:0.8rem;color:var(--text-muted)">No reservations yet</div>
    </div>
    <div class="panel-section">
      <div class="panel-title">Popular Tonight</div>
      <div style="font-size:0.8rem;color:var(--text-muted);line-height:1.9">
        ü•ó Caesar Salad ¬∑ <span style="color:var(--gold)">24 orders</span><br>
        ü•© Wagyu Tenderloin ¬∑ <span style="color:var(--gold)">18 orders</span><br>
        üç∑ Ch√¢teau Margaux ¬∑ <span style="color:var(--gold)">15 bottles</span><br>
        üçÆ Cr√®me Br√ªl√©e ¬∑ <span style="color:var(--gold)">31 orders</span>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <span style="font-size:1.5rem">üì±</span>
  <div><div class="toast-title" id="toastTitle">SMS Sent!</div><div class="toast-sub" id="toastSub"></div></div>
</div>

<script>
const RESTAURANTS = ["Maison Dor√©e","Sakura Garden","Trattoria Roma"];
let currentRestaurant = "Maison Dor√©e";

// INIT
document.getElementById('curDate').textContent = new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
renderRestList();
loadStats();
loadTables();
setTimeout(() => { sendToAPI("hello"); }, 700);
setInterval(loadStats, 10000); // Refresh stats every 10s

// RESTAURANT SWITCHING
function renderRestList() {
  document.getElementById('restList').innerHTML = RESTAURANTS.map(r => `
    <div class="rest-card ${r===currentRestaurant?'active':''}" onclick="switchRest('${r}')">
      <div class="rest-name">${r}</div>
      <div class="rest-meta">
        <span style="color:var(--gold)">‚òÖ 4.8</span>
        <span id="meta-${r.replace(/\s/g,'')}" style="font-size:0.72rem;color:var(--text-muted)">Loading...</span>
      </div>
    </div>`).join('');
}

async function switchRest(name) {
  currentRestaurant = name;
  renderRestList();
  loadTables();
  loadWaitlist();
  addBotMsg(`Switched to <strong>${name}</strong>! How can I help you? üîÑ`,
    ["Book a table","View menu","Join waitlist"]);
}

// API CALLS
async function sendToAPI(msg) {
  showTyping();
  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({message: msg, restaurant: currentRestaurant})
    });
    const data = await res.json();
    hideTyping();
    renderBotResponse(data);
    if (data.type === 'success' || data.type === 'reservations') {
      loadStats(); loadTables(); loadWaitlist(); updateMyReservations();
    }
  } catch(e) {
    hideTyping();
    addBotMsg("Sorry, I had a connection issue. Please try again!");
  }
}

async function loadStats() {
  try {
    const res = await fetch('/api/stats');
    const data = await res.json();
    const rest = data[currentRestaurant];
    if (rest) {
      document.getElementById('sTotal').textContent = rest.total_reservations;
      document.getElementById('sAvail').textContent = rest.available;
      document.getElementById('sWait').textContent = rest.waitlist_count;
      document.getElementById('sOcc').textContent = rest.occupancy_pct + '%';
    }
    // Update rest card meta
    for (const [name, stats] of Object.entries(data)) {
      const el = document.getElementById('meta-' + name.replace(/\s/g,''));
      if (el) el.textContent = `${stats.available} tables open`;
    }
  } catch(e) {}
}

async function loadTables() {
  try {
    const res = await fetch(`/api/tables/${encodeURIComponent(currentRestaurant)}`);
    const tables = await res.json();
    const grid = document.getElementById('tableGrid');
    grid.innerHTML = tables.slice(0,20).map(t => `
      <div class="tbl ${t.status}">
        <span style="font-size:0.9rem">${t.status==='reserved'?'üî¥':'üü¢'}</span>
        <span>${t.id}</span>
      </div>`).join('');
  } catch(e) {}
}

async function loadWaitlist() {
  try {
    const res = await fetch(`/api/waitlist/${encodeURIComponent(currentRestaurant)}`);
    const wl = await res.json();
    document.getElementById('wlCount').textContent = wl.length;
    document.getElementById('waitlistEl').innerHTML = wl.length === 0
      ? '<div style="font-size:0.8rem;color:var(--text-dim);padding:0.5rem 0">Waitlist is empty</div>'
      : wl.map(w => `
        <div class="wl-item">
          <div class="wl-avatar">${w.name[0]}</div>
          <div><div style="font-weight:500;font-size:0.8rem">${w.name}</div>
          <div style="font-size:0.72rem;color:var(--text-muted)">Party of ${w.party_size}</div></div>
          <div class="wl-wait">${w.estimated_wait}</div>
        </div>`).join('');
  } catch(e) {}
}

function updateMyReservations() {
  const reservations = JSON.parse(sessionStorage.getItem('reservations') || '[]');
  const el = document.getElementById('myReservations');
  if (reservations.length === 0) {
    el.textContent = 'No reservations yet';
  } else {
    el.innerHTML = reservations.map(r => `
      <div style="padding:0.6rem 0;border-bottom:1px solid var(--border)">
        <div style="font-weight:500">${r.name}</div>
        <div style="color:var(--text-muted);font-size:0.72rem">${r.date} ¬∑ ${r.time}</div>
        <div style="color:var(--gold);font-size:0.72rem;font-family:monospace">${r.conf_num}</div>
      </div>`).join('');
  }
}

// RENDER BOT RESPONSES
function renderBotResponse(data) {
  let html = `<p>${markdownBold(data.message)}</p>`;

  if (data.type === 'menu' && data.menu) {
    html += `<div class="menu-grid">${data.menu.map(item => `
      <div class="mi">
        <div class="mi-name">${item.name}</div>
        <div class="mi-desc">${item.desc}</div>
        <div class="mi-price">$${item.price}</div>
        ${(item.tags||[]).map(t=>`<span class="di-tag">${t}</span>`).join('')}
      </div>`).join('')}</div>`;
  }

  if (data.type === 'confirm' && data.details) {
    html += `<div class="bk-card">
      <div class="bk-title">üçΩÔ∏è Reservation Details</div>
      ${Object.entries(data.details).map(([k,v])=>`<div class="bk-row"><span>${k}</span><strong>${v}</strong></div>`).join('')}
      <div class="bk-btns">
        <button class="bk-btn primary" onclick="quickSend('Yes, confirm booking')">‚úì Confirm</button>
        <button class="bk-btn secondary" onclick="quickSend('No, make changes')">Edit</button>
      </div>
    </div>`;
  }

  if (data.type === 'success' && data.details) {
    const conf = data.details['Confirmation'] || '';
    html = `<div class="success-box">
      <div class="success-icon">üéâ</div>
      <div class="success-title">${data.message}</div>
      ${Object.entries(data.details).map(([k,v])=>`<div style="font-size:0.8rem;color:var(--text-muted)">${k}: <strong style="color:var(--text)">${v}</strong></div>`).join('')}
      ${conf ? `<div class="conf-num" style="margin-top:0.5rem">${conf}</div>` : ''}
      ${data.sms ? `<div class="sms-note">üì± ${data.sms}</div>` : ''}
    </div>`;
    // Store confirmation in sessionStorage for display
    const existing = JSON.parse(sessionStorage.getItem('reservations') || '[]');
    existing.push(data.details);
    sessionStorage.setItem('reservations', JSON.stringify(existing));
    updateMyReservations();
    showToast('üéâ', 'Booking Confirmed!', data.details['Name'] + ' ¬∑ ' + data.details['Time']);
  }

  if (data.type === 'reservations' && data.reservations && data.reservations.length > 0) {
    html += data.reservations.map(r => `
      <div class="bk-card">
        <div class="bk-title">üçΩÔ∏è ${r.restaurant}</div>
        ${['name','date','time','party_size','conf_num'].map(k=>`<div class="bk-row"><span>${k.replace('_',' ')}</span><strong>${r[k]}</strong></div>`).join('')}
        <div class="bk-btns">
          <button class="bk-btn secondary" onclick="quickSend('Cancel reservation ${r.conf_num}')">Cancel ${r.conf_num}</button>
        </div>
      </div>`).join('');
  }

  if (data.chips && data.chips.length > 0) {
    html += `<div class="chips">${data.chips.map(c=>`<button class="chip" onclick="quickSend('${c}')">${c}</button>`).join('')}</div>`;
  }

  addBotMsg(html, null, true);
}

function markdownBold(text) {
  return (text || '').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g,'<br>');
}

// CHAT HELPERS
function addBotMsg(html, chips, raw=false) {
  const msgs = document.getElementById('messages');
  const time = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  let content = raw ? html : `<p>${html}</p>`;
  if (chips) content += `<div class="chips">${chips.map(c=>`<button class="chip" onclick="quickSend('${c}')">${c}</button>`).join('')}</div>`;
  msgs.innerHTML += `<div class="msg bot"><div class="msg-av">ü§µ</div><div><div class="msg-bubble">${content}</div><div class="msg-time">${time}</div></div></div>`;
  msgs.scrollTop = msgs.scrollHeight;
}

function addUserMsg(text) {
  const msgs = document.getElementById('messages');
  const time = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  msgs.innerHTML += `<div class="msg user"><div class="msg-av">üë§</div><div><div class="msg-bubble">${text}</div><div class="msg-time">${time}</div></div></div>`;
  msgs.scrollTop = msgs.scrollHeight;
}

function quickSend(text) { document.getElementById('chatInput').value = text; sendMessage(); }
function handleKey(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} }
function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; }

function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  addUserMsg(text);
  input.value = ''; input.style.height = 'auto';
  sendToAPI(text);
}

function showTyping() { document.getElementById('typing').style.display='flex'; document.getElementById('messages').scrollTop=9999; }
function hideTyping() { document.getElementById('typing').style.display='none'; }

function showToast(icon, title, sub) {
  const t = document.getElementById('toast');
  t.querySelector('span').textContent = icon;
  document.getElementById('toastTitle').textContent = title;
  document.getElementById('toastSub').textContent = sub;
  t.style.display = 'flex';
  setTimeout(()=>{ t.style.display='none'; }, 5000);
}

// Initial loads
loadWaitlist();
updateMyReservations();
</script>
</body>
</html>
